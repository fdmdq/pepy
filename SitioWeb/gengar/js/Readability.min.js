/*eslint-env es6:false*/
/*
 * Copyright (c) 2010 Arc90 Inc
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/*
 * This code is heavily based on Arc90's readability.js (1.7.1) script
 * available at: http://code.google.com/p/arc90labs-readability
 */
function Readability(e,t){if(t&&t.documentElement){e=t;t=arguments[2]}else if(!e||!e.documentElement){throw new Error("First argument to Readability constructor should be a document object.")}t=t||{};this._doc=e;this._docJSDOMParser=this._doc.firstChild.__JSDOMParser__;this._articleTitle=null;this._articleByline=null;this._articleDir=null;this._articleSiteName=null;this._attempts=[];this._debug=!!t.debug;this._maxElemsToParse=t.maxElemsToParse||this.DEFAULT_MAX_ELEMS_TO_PARSE;this._nbTopCandidates=t.nbTopCandidates||this.DEFAULT_N_TOP_CANDIDATES;this._charThreshold=t.charThreshold||this.DEFAULT_CHAR_THRESHOLD;this._classesToPreserve=this.CLASSES_TO_PRESERVE.concat(t.classesToPreserve||[]);this._keepClasses=!!t.keepClasses;this._serializer=t.serializer||function(e){return e.innerHTML};this._disableJSONLD=!!t.disableJSONLD;this._flags=this.FLAG_STRIP_UNLIKELYS|this.FLAG_WEIGHT_CLASSES|this.FLAG_CLEAN_CONDITIONALLY;if(this._debug){let e=function(e){if(e.nodeType==e.TEXT_NODE){return`${e.nodeName} ("${e.textContent}")`}let t=Array.from(e.attributes||[],(function(e){return`${e.name}="${e.value}"`})).join(" ");return`<${e.localName} ${t}>`};this.log=function(){if(typeof dump!=="undefined"){var t=Array.prototype.map.call(arguments,(function(t){return t&&t.nodeName?e(t):t})).join(" ");dump("Reader: (Readability) "+t+"\n")}else if(typeof console!=="undefined"){let t=Array.from(arguments,(t=>{if(t&&t.nodeType==this.ELEMENT_NODE){return e(t)}return t}));t.unshift("Reader: (Readability)");console.log.apply(console,t)}}}else{this.log=function(){}}}Readability.prototype={FLAG_STRIP_UNLIKELYS:1,FLAG_WEIGHT_CLASSES:2,FLAG_CLEAN_CONDITIONALLY:4,ELEMENT_NODE:1,TEXT_NODE:3,DEFAULT_MAX_ELEMS_TO_PARSE:0,DEFAULT_N_TOP_CANDIDATES:5,DEFAULT_TAGS_TO_SCORE:"section,h2,h3,h4,h5,h6,p,td,pre".toUpperCase().split(","),DEFAULT_CHAR_THRESHOLD:500,REGEXPS:{unlikelyCandidates:/-ad-|ai2html|banner|breadcrumbs|combx|comment|community|cover-wrap|disqus|extra|footer|gdpr|header|legends|menu|related|remark|replies|rss|shoutbox|sidebar|skyscraper|social|sponsor|supplemental|ad-break|agegate|pagination|pager|popup|yom-remote/i,okMaybeItsACandidate:/and|article|body|column|content|main|shadow/i,positive:/article|body|content|entry|hentry|h-entry|main|page|pagination|post|text|blog|story/i,negative:/-ad-|hidden|^hid$| hid$| hid |^hid |banner|combx|comment|com-|contact|foot|footer|footnote|gdpr|masthead|media|meta|outbrain|promo|related|scroll|share|shoutbox|sidebar|skyscraper|sponsor|shopping|tags|tool|widget/i,extraneous:/print|archive|comment|discuss|e[\-]?mail|share|reply|all|login|sign|single|utility/i,byline:/byline|author|dateline|writtenby|p-author/i,replaceFonts:/<(\/?)font[^>]*>/gi,normalize:/\s{2,}/g,videos:/\/\/(www\.)?((dailymotion|youtube|youtube-nocookie|player\.vimeo|v\.qq)\.com|(archive|upload\.wikimedia)\.org|player\.twitch\.tv)/i,shareElements:/(\b|_)(share|sharedaddy)(\b|_)/i,nextLink:/(next|weiter|continue|>([^\|]|$)|»([^\|]|$))/i,prevLink:/(prev|earl|old|new|<|«)/i,tokenize:/\W+/g,whitespace:/^\s*$/,hasContent:/\S$/,hashUrl:/^#.+/,srcsetUrl:/(\S+)(\s+[\d.]+[xw])?(\s*(?:,|$))/g,b64DataUrl:/^data:\s*([^\s;,]+)\s*;\s*base64\s*,/i,jsonLdArticleTypes:/^Article|AdvertiserContentArticle|NewsArticle|AnalysisNewsArticle|AskPublicNewsArticle|BackgroundNewsArticle|OpinionNewsArticle|ReportageNewsArticle|ReviewNewsArticle|Report|SatiricalArticle|ScholarlyArticle|MedicalScholarlyArticle|SocialMediaPosting|BlogPosting|LiveBlogPosting|DiscussionForumPosting|TechArticle|APIReference$/},UNLIKELY_ROLES:["menu","menubar","complementary","navigation","alert","alertdialog","dialog"],DIV_TO_P_ELEMS:new Set(["BLOCKQUOTE","DL","DIV","IMG","OL","P","PRE","TABLE","UL"]),ALTER_TO_DIV_EXCEPTIONS:["DIV","ARTICLE","SECTION","P"],PRESENTATIONAL_ATTRIBUTES:["align","background","bgcolor","border","cellpadding","cellspacing","frame","hspace","rules","style","valign","vspace"],DEPRECATED_SIZE_ATTRIBUTE_ELEMS:["TABLE","TH","TD","HR","PRE"],PHRASING_ELEMS:["ABBR","AUDIO","B","BDO","BR","BUTTON","CITE","CODE","DATA","DATALIST","DFN","EM","EMBED","I","IMG","INPUT","KBD","LABEL","MARK","MATH","METER","NOSCRIPT","OBJECT","OUTPUT","PROGRESS","Q","RUBY","SAMP","SCRIPT","SELECT","SMALL","SPAN","STRONG","SUB","SUP","TEXTAREA","TIME","VAR","WBR"],CLASSES_TO_PRESERVE:["page"],HTML_ESCAPE_MAP:{lt:"<",gt:">",amp:"&",quot:'"',apos:"'"},_postProcessContent:function(e){this._fixRelativeUris(e);this._simplifyNestedElements(e);if(!this._keepClasses){this._cleanClasses(e)}},_removeNodes:function(e,t){if(this._docJSDOMParser&&e._isLiveNodeList){throw new Error("Do not pass live node lists to _removeNodes")}for(var i=e.length-1;i>=0;i--){var a=e[i];var r=a.parentNode;if(r){if(!t||t.call(this,a,i,e)){r.removeChild(a)}}}},_replaceNodeTags:function(e,t){if(this._docJSDOMParser&&e._isLiveNodeList){throw new Error("Do not pass live node lists to _replaceNodeTags")}for(const i of e){this._setNodeTag(i,t)}},_forEachNode:function(e,t){Array.prototype.forEach.call(e,t,this)},_findNode:function(e,t){return Array.prototype.find.call(e,t,this)},_someNode:function(e,t){return Array.prototype.some.call(e,t,this)},_everyNode:function(e,t){return Array.prototype.every.call(e,t,this)},_concatNodeLists:function(){var e=Array.prototype.slice;var t=e.call(arguments);var i=t.map((function(t){return e.call(t)}));return Array.prototype.concat.apply([],i)},_getAllNodesWithTag:function(e,t){if(e.querySelectorAll){return e.querySelectorAll(t.join(","))}return[].concat.apply([],t.map((function(t){var i=e.getElementsByTagName(t);return Array.isArray(i)?i:Array.from(i)})))},_cleanClasses:function(e){var t=this._classesToPreserve;var i=(e.getAttribute("class")||"").split(/\s+/).filter((function(e){return t.indexOf(e)!=-1})).join(" ");if(i){e.setAttribute("class",i)}else{e.removeAttribute("class")}for(e=e.firstElementChild;e;e=e.nextElementSibling){this._cleanClasses(e)}},_fixRelativeUris:function(e){var t=this._doc.baseURI;var i=this._doc.documentURI;function a(e){if(t==i&&e.charAt(0)=="#"){return e}try{return new URL(e,t).href}catch(e){}return e}var r=this._getAllNodesWithTag(e,["a"]);this._forEachNode(r,(function(e){var t=e.getAttribute("href");if(t){if(t.indexOf("javascript:")===0){if(e.childNodes.length===1&&e.childNodes[0].nodeType===this.TEXT_NODE){var i=this._doc.createTextNode(e.textContent);e.parentNode.replaceChild(i,e)}else{var r=this._doc.createElement("span");while(e.firstChild){r.appendChild(e.firstChild)}e.parentNode.replaceChild(r,e)}}else{e.setAttribute("href",a(t))}}}));var n=this._getAllNodesWithTag(e,["img","picture","figure","video","audio","source"]);this._forEachNode(n,(function(e){var t=e.getAttribute("src");var i=e.getAttribute("poster");var r=e.getAttribute("srcset");if(t){e.setAttribute("src",a(t))}if(i){e.setAttribute("poster",a(i))}if(r){var n=r.replace(this.REGEXPS.srcsetUrl,(function(e,t,i,r){return a(t)+(i||"")+r}));e.setAttribute("srcset",n)}}))},_simplifyNestedElements:function(e){var t=e;while(t){if(t.parentNode&&["DIV","SECTION"].includes(t.tagName)&&!(t.id&&t.id.startsWith("readability"))){if(this._isElementWithoutContent(t)){t=this._removeAndGetNext(t);continue}else if(this._hasSingleTagInsideElement(t,"DIV")||this._hasSingleTagInsideElement(t,"SECTION")){var i=t.children[0];for(var a=0;a<t.attributes.length;a++){i.setAttribute(t.attributes[a].name,t.attributes[a].value)}t.parentNode.replaceChild(i,t);t=i;continue}}t=this._getNextNode(t)}},_getArticleTitle:function(){var e=this._doc;var t="";var i="";try{t=i=e.title.trim();if(typeof t!=="string")t=i=this._getInnerText(e.getElementsByTagName("title")[0])}catch(e){}var a=false;function r(e){return e.split(/\s+/).length}if(/ [\|\-\\\/>»] /.test(t)){a=/ [\\\/>»] /.test(t);t=i.replace(/(.*)[\|\-\\\/>»] .*/gi,"$1");if(r(t)<3)t=i.replace(/[^\|\-\\\/>»]*[\|\-\\\/>»](.*)/gi,"$1")}else if(t.indexOf(": ")!==-1){var n=this._concatNodeLists(e.getElementsByTagName("h1"),e.getElementsByTagName("h2"));var s=t.trim();var l=this._someNode(n,(function(e){return e.textContent.trim()===s}));if(!l){t=i.substring(i.lastIndexOf(":")+1);if(r(t)<3){t=i.substring(i.indexOf(":")+1)}else if(r(i.substr(0,i.indexOf(":")))>5){t=i}}}else if(t.length>150||t.length<15){var o=e.getElementsByTagName("h1");if(o.length===1)t=this._getInnerText(o[0])}t=t.trim().replace(this.REGEXPS.normalize," ");var h=r(t);if(h<=4&&(!a||h!=r(i.replace(/[\|\-\\\/>»]+/g,""))-1)){t=i}return t},_prepDocument:function(){var e=this._doc;this._removeNodes(this._getAllNodesWithTag(e,["style"]));if(e.body){this._replaceBrs(e.body)}this._replaceNodeTags(this._getAllNodesWithTag(e,["font"]),"SPAN")},_nextNode:function(e){var t=e;while(t&&t.nodeType!=this.ELEMENT_NODE&&this.REGEXPS.whitespace.test(t.textContent)){t=t.nextSibling}return t},_replaceBrs:function(e){this._forEachNode(this._getAllNodesWithTag(e,["br"]),(function(e){var t=e.nextSibling;var i=false;while((t=this._nextNode(t))&&t.tagName=="BR"){i=true;var a=t.nextSibling;t.parentNode.removeChild(t);t=a}if(i){var r=this._doc.createElement("p");e.parentNode.replaceChild(r,e);t=r.nextSibling;while(t){if(t.tagName=="BR"){var n=this._nextNode(t.nextSibling);if(n&&n.tagName=="BR")break}if(!this._isPhrasingContent(t))break;var s=t.nextSibling;r.appendChild(t);t=s}while(r.lastChild&&this._isWhitespace(r.lastChild)){r.removeChild(r.lastChild)}if(r.parentNode.tagName==="P")this._setNodeTag(r.parentNode,"DIV")}}))},_setNodeTag:function(e,t){this.log("_setNodeTag",e,t);if(this._docJSDOMParser){e.localName=t.toLowerCase();e.tagName=t.toUpperCase();return e}var i=e.ownerDocument.createElement(t);while(e.firstChild){i.appendChild(e.firstChild)}e.parentNode.replaceChild(i,e);if(e.readability)i.readability=e.readability;for(var a=0;a<e.attributes.length;a++){try{i.setAttribute(e.attributes[a].name,e.attributes[a].value)}catch(e){}}return i},_prepArticle:function(e){this._cleanStyles(e);this._markDataTables(e);this._fixLazyImages(e);this._cleanConditionally(e,"form");this._cleanConditionally(e,"fieldset");this._clean(e,"object");this._clean(e,"embed");this._clean(e,"footer");this._clean(e,"link");this._clean(e,"aside");var t=this.DEFAULT_CHAR_THRESHOLD;this._forEachNode(e.children,(function(e){this._cleanMatchedNodes(e,(function(e,i){return this.REGEXPS.shareElements.test(i)&&e.textContent.length<t}))}));this._clean(e,"iframe");this._clean(e,"input");this._clean(e,"textarea");this._clean(e,"select");this._clean(e,"button");this._cleanHeaders(e);this._cleanConditionally(e,"table");this._cleanConditionally(e,"ul");this._cleanConditionally(e,"div");this._replaceNodeTags(this._getAllNodesWithTag(e,["h1"]),"h2");this._removeNodes(this._getAllNodesWithTag(e,["p"]),(function(e){var t=e.getElementsByTagName("img").length;var i=e.getElementsByTagName("embed").length;var a=e.getElementsByTagName("object").length;var r=e.getElementsByTagName("iframe").length;var n=t+i+a+r;return n===0&&!this._getInnerText(e,false)}));this._forEachNode(this._getAllNodesWithTag(e,["br"]),(function(e){var t=this._nextNode(e.nextSibling);if(t&&t.tagName=="P")e.parentNode.removeChild(e)}));this._forEachNode(this._getAllNodesWithTag(e,["table"]),(function(e){var t=this._hasSingleTagInsideElement(e,"TBODY")?e.firstElementChild:e;if(this._hasSingleTagInsideElement(t,"TR")){var i=t.firstElementChild;if(this._hasSingleTagInsideElement(i,"TD")){var a=i.firstElementChild;a=this._setNodeTag(a,this._everyNode(a.childNodes,this._isPhrasingContent)?"P":"DIV");e.parentNode.replaceChild(a,e)}}}))},_initializeNode:function(e){e.readability={contentScore:0};switch(e.tagName){case"DIV":e.readability.contentScore+=5;break;case"PRE":case"TD":case"BLOCKQUOTE":e.readability.contentScore+=3;break;case"ADDRESS":case"OL":case"UL":case"DL":case"DD":case"DT":case"LI":case"FORM":e.readability.contentScore-=3;break;case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"TH":e.readability.contentScore-=5;break}e.readability.contentScore+=this._getClassWeight(e)},_removeAndGetNext:function(e){var t=this._getNextNode(e,true);e.parentNode.removeChild(e);return t},_getNextNode:function(e,t){if(!t&&e.firstElementChild){return e.firstElementChild}if(e.nextElementSibling){return e.nextElementSibling}do{e=e.parentNode}while(e&&!e.nextElementSibling);return e&&e.nextElementSibling},_textSimilarity:function(e,t){var i=e.toLowerCase().split(this.REGEXPS.tokenize).filter(Boolean);var a=t.toLowerCase().split(this.REGEXPS.tokenize).filter(Boolean);if(!i.length||!a.length){return 0}var r=a.filter((e=>!i.includes(e)));var n=r.join(" ").length/a.join(" ").length;return 1-n},_checkByline:function(e,t){if(this._articleByline){return false}if(e.getAttribute!==undefined){var i=e.getAttribute("rel");var a=e.getAttribute("itemprop")}if((i==="author"||a&&a.indexOf("author")!==-1||this.REGEXPS.byline.test(t))&&this._isValidByline(e.textContent)){this._articleByline=e.textContent.trim();return true}return false},_getNodeAncestors:function(e,t){t=t||0;var i=0,a=[];while(e.parentNode){a.push(e.parentNode);if(t&&++i===t)break;e=e.parentNode}return a},_grabArticle:function(e){this.log("**** grabArticle ****");var t=this._doc;var i=e!==null;e=e?e:this._doc.body;if(!e){this.log("No body found in document. Abort.");return null}var a=e.innerHTML;while(true){this.log("Starting grabArticle loop");var r=this._flagIsActive(this.FLAG_STRIP_UNLIKELYS);var n=[];var s=this._doc.documentElement;let $=true;while(s){if(s.tagName==="HTML"){this._articleLang=s.getAttribute("lang")}var l=s.className+" "+s.id;if(!this._isProbablyVisible(s)){this.log("Removing hidden node - "+l);s=this._removeAndGetNext(s);continue}if(this._checkByline(s,l)){s=this._removeAndGetNext(s);continue}if($&&this._headerDuplicatesTitle(s)){this.log("Removing header: ",s.textContent.trim(),this._articleTitle.trim());$=false;s=this._removeAndGetNext(s);continue}if(r){if(this.REGEXPS.unlikelyCandidates.test(l)&&!this.REGEXPS.okMaybeItsACandidate.test(l)&&!this._hasAncestorTag(s,"table")&&!this._hasAncestorTag(s,"code")&&s.tagName!=="BODY"&&s.tagName!=="A"){this.log("Removing unlikely candidate - "+l);s=this._removeAndGetNext(s);continue}if(this.UNLIKELY_ROLES.includes(s.getAttribute("role"))){this.log("Removing content with role "+s.getAttribute("role")+" - "+l);s=this._removeAndGetNext(s);continue}}if((s.tagName==="DIV"||s.tagName==="SECTION"||s.tagName==="HEADER"||s.tagName==="H1"||s.tagName==="H2"||s.tagName==="H3"||s.tagName==="H4"||s.tagName==="H5"||s.tagName==="H6")&&this._isElementWithoutContent(s)){s=this._removeAndGetNext(s);continue}if(this.DEFAULT_TAGS_TO_SCORE.indexOf(s.tagName)!==-1){n.push(s)}if(s.tagName==="DIV"){var o=null;var h=s.firstChild;while(h){var c=h.nextSibling;if(this._isPhrasingContent(h)){if(o!==null){o.appendChild(h)}else if(!this._isWhitespace(h)){o=t.createElement("p");s.replaceChild(o,h);o.appendChild(h)}}else if(o!==null){while(o.lastChild&&this._isWhitespace(o.lastChild)){o.removeChild(o.lastChild)}o=null}h=c}if(this._hasSingleTagInsideElement(s,"P")&&this._getLinkDensity(s)<.25){var d=s.children[0];s.parentNode.replaceChild(d,s);s=d;n.push(s)}else if(!this._hasChildBlockElement(s)){s=this._setNodeTag(s,"P");n.push(s)}}s=this._getNextNode(s)}var g=[];this._forEachNode(n,(function(e){if(!e.parentNode||typeof e.parentNode.tagName==="undefined")return;var t=this._getInnerText(e);if(t.length<25)return;var i=this._getNodeAncestors(e,5);if(i.length===0)return;var a=0;a+=1;a+=t.split(",").length;a+=Math.min(Math.floor(t.length/100),3);this._forEachNode(i,(function(e,t){if(!e.tagName||!e.parentNode||typeof e.parentNode.tagName==="undefined")return;if(typeof e.readability==="undefined"){this._initializeNode(e);g.push(e)}if(t===0)var i=1;else if(t===1)i=2;else i=t*3;e.readability.contentScore+=a/i}))}));var u=[];for(var f=0,_=g.length;f<_;f+=1){var m=g[f];var p=m.readability.contentScore*(1-this._getLinkDensity(m));m.readability.contentScore=p;this.log("Candidate:",m,"with score "+p);for(var N=0;N<this._nbTopCandidates;N++){var v=u[N];if(!v||p>v.readability.contentScore){u.splice(N,0,m);if(u.length>this._nbTopCandidates)u.pop();break}}}var E=u[0]||null;var T=false;var b;if(E===null||E.tagName==="BODY"){E=t.createElement("DIV");T=true;while(e.firstChild){this.log("Moving child out:",e.firstChild);E.appendChild(e.firstChild)}e.appendChild(E);this._initializeNode(E)}else if(E){var A=[];for(var y=1;y<u.length;y++){if(u[y].readability.contentScore/E.readability.contentScore>=.75){A.push(this._getNodeAncestors(u[y]))}}var S=3;if(A.length>=S){b=E.parentNode;while(b.tagName!=="BODY"){var C=0;for(var L=0;L<A.length&&C<S;L++){C+=Number(A[L].includes(b))}if(C>=S){E=b;break}b=b.parentNode}}if(!E.readability){this._initializeNode(E)}b=E.parentNode;var x=E.readability.contentScore;var I=x/3;while(b.tagName!=="BODY"){if(!b.readability){b=b.parentNode;continue}var D=b.readability.contentScore;if(D<I)break;if(D>x){E=b;break}x=b.readability.contentScore;b=b.parentNode}b=E.parentNode;while(b.tagName!="BODY"&&b.children.length==1){E=b;b=E.parentNode}if(!E.readability){this._initializeNode(E)}}var R=t.createElement("DIV");if(i)R.id="readability-content";var P=Math.max(10,E.readability.contentScore*.2);b=E.parentNode;var O=b.children;for(var w=0,B=O.length;w<B;w++){var G=O[w];var M=false;this.log("Looking at sibling node:",G,G.readability?"with score "+G.readability.contentScore:"");this.log("Sibling has score",G.readability?G.readability.contentScore:"Unknown");if(G===E){M=true}else{var H=0;if(G.className===E.className&&E.className!=="")H+=E.readability.contentScore*.2;if(G.readability&&G.readability.contentScore+H>=P){M=true}else if(G.nodeName==="P"){var U=this._getLinkDensity(G);var k=this._getInnerText(G);var W=k.length;if(W>80&&U<.25){M=true}else if(W<80&&W>0&&U===0&&k.search(/\.( |$)/)!==-1){M=true}}}if(M){this.log("Appending node:",G);if(this.ALTER_TO_DIV_EXCEPTIONS.indexOf(G.nodeName)===-1){this.log("Altering sibling:",G,"to div.");G=this._setNodeTag(G,"DIV")}R.appendChild(G);O=b.children;w-=1;B-=1}}if(this._debug)this.log("Article content pre-prep: "+R.innerHTML);this._prepArticle(R);if(this._debug)this.log("Article content post-prep: "+R.innerHTML);if(T){E.id="readability-page-1";E.className="page"}else{var X=t.createElement("DIV");X.id="readability-page-1";X.className="page";while(R.firstChild){X.appendChild(R.firstChild)}R.appendChild(X)}if(this._debug)this.log("Article content after paging: "+R.innerHTML);var F=true;var j=this._getInnerText(R,true).length;if(j<this._charThreshold){F=false;e.innerHTML=a;if(this._flagIsActive(this.FLAG_STRIP_UNLIKELYS)){this._removeFlag(this.FLAG_STRIP_UNLIKELYS);this._attempts.push({articleContent:R,textLength:j})}else if(this._flagIsActive(this.FLAG_WEIGHT_CLASSES)){this._removeFlag(this.FLAG_WEIGHT_CLASSES);this._attempts.push({articleContent:R,textLength:j})}else if(this._flagIsActive(this.FLAG_CLEAN_CONDITIONALLY)){this._removeFlag(this.FLAG_CLEAN_CONDITIONALLY);this._attempts.push({articleContent:R,textLength:j})}else{this._attempts.push({articleContent:R,textLength:j});this._attempts.sort((function(e,t){return t.textLength-e.textLength}));if(!this._attempts[0].textLength){return null}R=this._attempts[0].articleContent;F=true}}if(F){var V=[b,E].concat(this._getNodeAncestors(b));this._someNode(V,(function(e){if(!e.tagName)return false;var t=e.getAttribute("dir");if(t){this._articleDir=t;return true}return false}));return R}}},_isValidByline:function(e){if(typeof e=="string"||e instanceof String){e=e.trim();return e.length>0&&e.length<100}return false},_unescapeHtmlEntities:function(e){if(!e){return e}var t=this.HTML_ESCAPE_MAP;return e.replace(/&(quot|amp|apos|lt|gt);/g,(function(e,i){return t[i]})).replace(/&#(?:x([0-9a-z]{1,4})|([0-9]{1,4}));/gi,(function(e,t,i){var a=parseInt(t||i,t?16:10);return String.fromCharCode(a)}))},_getJSONLD:function(e){var t=this._getAllNodesWithTag(e,["script"]);var i;this._forEachNode(t,(function(e){if(!i&&e.getAttribute("type")==="application/ld+json"){try{var t=e.textContent.replace(/^\s*<!\[CDATA\[|\]\]>\s*$/g,"");var a=JSON.parse(t);if(!a["@context"]||!a["@context"].match(/^https?\:\/\/schema\.org$/)){return}if(!a["@type"]&&Array.isArray(a["@graph"])){a=a["@graph"].find((function(e){return(e["@type"]||"").match(this.REGEXPS.jsonLdArticleTypes)}))}if(!a||!a["@type"]||!a["@type"].match(this.REGEXPS.jsonLdArticleTypes)){return}i={};if(typeof a.name==="string"&&typeof a.headline==="string"&&a.name!==a.headline){var r=this._getArticleTitle();var n=this._textSimilarity(a.name,r)>.75;var s=this._textSimilarity(a.headline,r)>.75;if(s&&!n){i.title=a.headline}else{i.title=a.name}}else if(typeof a.name==="string"){i.title=a.name.trim()}else if(typeof a.headline==="string"){i.title=a.headline.trim()}if(a.author){if(typeof a.author.name==="string"){i.byline=a.author.name.trim()}else if(Array.isArray(a.author)&&a.author[0]&&typeof a.author[0].name==="string"){i.byline=a.author.filter((function(e){return e&&typeof e.name==="string"})).map((function(e){return e.name.trim()})).join(", ")}}if(typeof a.description==="string"){i.excerpt=a.description.trim()}if(a.publisher&&typeof a.publisher.name==="string"){i.siteName=a.publisher.name.trim()}return}catch(e){this.log(e.message)}}}));return i?i:{}},_getArticleMetadata:function(e){var t={};var i={};var a=this._doc.getElementsByTagName("meta");var r=/\s*(dc|dcterm|og|twitter)\s*:\s*(author|creator|description|title|site_name)\s*/gi;var n=/^\s*(?:(dc|dcterm|og|twitter|weibo:(article|webpage))\s*[\.:]\s*)?(author|creator|description|title|site_name)\s*$/i;this._forEachNode(a,(function(e){var t=e.getAttribute("name");var a=e.getAttribute("property");var s=e.getAttribute("content");if(!s){return}var l=null;var o=null;if(a){l=a.match(r);if(l){o=l[0].toLowerCase().replace(/\s/g,"");i[o]=s.trim()}}if(!l&&t&&n.test(t)){o=t;if(s){o=o.toLowerCase().replace(/\s/g,"").replace(/\./g,":");i[o]=s.trim()}}}));t.title=e.title||i["dc:title"]||i["dcterm:title"]||i["og:title"]||i["weibo:article:title"]||i["weibo:webpage:title"]||i["title"]||i["twitter:title"];if(!t.title){t.title=this._getArticleTitle()}t.byline=e.byline||i["dc:creator"]||i["dcterm:creator"]||i["author"];t.excerpt=e.excerpt||i["dc:description"]||i["dcterm:description"]||i["og:description"]||i["weibo:article:description"]||i["weibo:webpage:description"]||i["description"]||i["twitter:description"];t.siteName=e.siteName||i["og:site_name"];t.title=this._unescapeHtmlEntities(t.title);t.byline=this._unescapeHtmlEntities(t.byline);t.excerpt=this._unescapeHtmlEntities(t.excerpt);t.siteName=this._unescapeHtmlEntities(t.siteName);return t},_isSingleImage:function(e){if(e.tagName==="IMG"){return true}if(e.children.length!==1||e.textContent.trim()!==""){return false}return this._isSingleImage(e.children[0])},_unwrapNoscriptImages:function(e){var t=Array.from(e.getElementsByTagName("img"));this._forEachNode(t,(function(e){for(var t=0;t<e.attributes.length;t++){var i=e.attributes[t];switch(i.name){case"src":case"srcset":case"data-src":case"data-srcset":return}if(/\.(jpg|jpeg|png|webp)/i.test(i.value)){return}}e.parentNode.removeChild(e)}));var i=Array.from(e.getElementsByTagName("noscript"));this._forEachNode(i,(function(t){var i=e.createElement("div");i.innerHTML=t.innerHTML;if(!this._isSingleImage(i)){return}var a=t.previousElementSibling;if(a&&this._isSingleImage(a)){var r=a;if(r.tagName!=="IMG"){r=a.getElementsByTagName("img")[0]}var n=i.getElementsByTagName("img")[0];for(var s=0;s<r.attributes.length;s++){var l=r.attributes[s];if(l.value===""){continue}if(l.name==="src"||l.name==="srcset"||/\.(jpg|jpeg|png|webp)/i.test(l.value)){if(n.getAttribute(l.name)===l.value){continue}var o=l.name;if(n.hasAttribute(o)){o="data-old-"+o}n.setAttribute(o,l.value)}}t.parentNode.replaceChild(i.firstElementChild,a)}}))},_removeScripts:function(e){this._removeNodes(this._getAllNodesWithTag(e,["script"]),(function(e){e.nodeValue="";e.removeAttribute("src");return true}));this._removeNodes(this._getAllNodesWithTag(e,["noscript"]))},_hasSingleTagInsideElement:function(e,t){if(e.children.length!=1||e.children[0].tagName!==t){return false}return!this._someNode(e.childNodes,(function(e){return e.nodeType===this.TEXT_NODE&&this.REGEXPS.hasContent.test(e.textContent)}))},_isElementWithoutContent:function(e){return e.nodeType===this.ELEMENT_NODE&&e.textContent.trim().length==0&&(e.children.length==0||e.children.length==e.getElementsByTagName("br").length+e.getElementsByTagName("hr").length)},_hasChildBlockElement:function(e){return this._someNode(e.childNodes,(function(e){return this.DIV_TO_P_ELEMS.has(e.tagName)||this._hasChildBlockElement(e)}))},_isPhrasingContent:function(e){return e.nodeType===this.TEXT_NODE||this.PHRASING_ELEMS.indexOf(e.tagName)!==-1||(e.tagName==="A"||e.tagName==="DEL"||e.tagName==="INS")&&this._everyNode(e.childNodes,this._isPhrasingContent)},_isWhitespace:function(e){return e.nodeType===this.TEXT_NODE&&e.textContent.trim().length===0||e.nodeType===this.ELEMENT_NODE&&e.tagName==="BR"},_getInnerText:function(e,t){t=typeof t==="undefined"?true:t;var i=e.textContent.trim();if(t){return i.replace(this.REGEXPS.normalize," ")}return i},_getCharCount:function(e,t){t=t||",";return this._getInnerText(e).split(t).length-1},_cleanStyles:function(e){if(!e||e.tagName.toLowerCase()==="svg")return;for(var t=0;t<this.PRESENTATIONAL_ATTRIBUTES.length;t++){e.removeAttribute(this.PRESENTATIONAL_ATTRIBUTES[t])}if(this.DEPRECATED_SIZE_ATTRIBUTE_ELEMS.indexOf(e.tagName)!==-1){e.removeAttribute("width");e.removeAttribute("height")}var i=e.firstElementChild;while(i!==null){this._cleanStyles(i);i=i.nextElementSibling}},_getLinkDensity:function(e){var t=this._getInnerText(e).length;if(t===0)return 0;var i=0;this._forEachNode(e.getElementsByTagName("a"),(function(e){var t=e.getAttribute("href");var a=t&&this.REGEXPS.hashUrl.test(t)?.3:1;i+=this._getInnerText(e).length*a}));return i/t},_getClassWeight:function(e){if(!this._flagIsActive(this.FLAG_WEIGHT_CLASSES))return 0;var t=0;if(typeof e.className==="string"&&e.className!==""){if(this.REGEXPS.negative.test(e.className))t-=25;if(this.REGEXPS.positive.test(e.className))t+=25}if(typeof e.id==="string"&&e.id!==""){if(this.REGEXPS.negative.test(e.id))t-=25;if(this.REGEXPS.positive.test(e.id))t+=25}return t},_clean:function(e,t){var i=["object","embed","iframe"].indexOf(t)!==-1;this._removeNodes(this._getAllNodesWithTag(e,[t]),(function(e){if(i){for(var t=0;t<e.attributes.length;t++){if(this.REGEXPS.videos.test(e.attributes[t].value)){return false}}if(e.tagName==="object"&&this.REGEXPS.videos.test(e.innerHTML)){return false}}return true}))},_hasAncestorTag:function(e,t,i,a){i=i||3;t=t.toUpperCase();var r=0;while(e.parentNode){if(i>0&&r>i)return false;if(e.parentNode.tagName===t&&(!a||a(e.parentNode)))return true;e=e.parentNode;r++}return false},_getRowAndColumnCount:function(e){var t=0;var i=0;var a=e.getElementsByTagName("tr");for(var r=0;r<a.length;r++){var n=a[r].getAttribute("rowspan")||0;if(n){n=parseInt(n,10)}t+=n||1;var s=0;var l=a[r].getElementsByTagName("td");for(var o=0;o<l.length;o++){var h=l[o].getAttribute("colspan")||0;if(h){h=parseInt(h,10)}s+=h||1}i=Math.max(i,s)}return{rows:t,columns:i}},_markDataTables:function(e){var t=e.getElementsByTagName("table");for(var i=0;i<t.length;i++){var a=t[i];var r=a.getAttribute("role");if(r=="presentation"){a._readabilityDataTable=false;continue}var n=a.getAttribute("datatable");if(n=="0"){a._readabilityDataTable=false;continue}var s=a.getAttribute("summary");if(s){a._readabilityDataTable=true;continue}var l=a.getElementsByTagName("caption")[0];if(l&&l.childNodes.length>0){a._readabilityDataTable=true;continue}var o=["col","colgroup","tfoot","thead","th"];var h=function(e){return!!a.getElementsByTagName(e)[0]};if(o.some(h)){this.log("Data table because found data-y descendant");a._readabilityDataTable=true;continue}if(a.getElementsByTagName("table")[0]){a._readabilityDataTable=false;continue}var c=this._getRowAndColumnCount(a);if(c.rows>=10||c.columns>4){a._readabilityDataTable=true;continue}a._readabilityDataTable=c.rows*c.columns>10}},_fixLazyImages:function(e){this._forEachNode(this._getAllNodesWithTag(e,["img","picture","figure"]),(function(e){if(e.src&&this.REGEXPS.b64DataUrl.test(e.src)){var t=this.REGEXPS.b64DataUrl.exec(e.src);if(t[1]==="image/svg+xml"){return}var i=false;for(var a=0;a<e.attributes.length;a++){var r=e.attributes[a];if(r.name==="src"){continue}if(/\.(jpg|jpeg|png|webp)/i.test(r.value)){i=true;break}}if(i){var n=e.src.search(/base64\s*/i)+7;var s=e.src.length-n;if(s<133){e.removeAttribute("src")}}}if((e.src||e.srcset&&e.srcset!="null")&&e.className.toLowerCase().indexOf("lazy")===-1){return}for(var l=0;l<e.attributes.length;l++){r=e.attributes[l];if(r.name==="src"||r.name==="srcset"||r.name==="alt"){continue}var o=null;if(/\.(jpg|jpeg|png|webp)\s+\d/.test(r.value)){o="srcset"}else if(/^\s*\S+\.(jpg|jpeg|png|webp)\S*\s*$/.test(r.value)){o="src"}if(o){if(e.tagName==="IMG"||e.tagName==="PICTURE"){e.setAttribute(o,r.value)}else if(e.tagName==="FIGURE"&&!this._getAllNodesWithTag(e,["img","picture"]).length){var h=this._doc.createElement("img");h.setAttribute(o,r.value);e.appendChild(h)}}}}))},_getTextDensity:function(e,t){var i=this._getInnerText(e,true).length;if(i===0){return 0}var a=0;var r=this._getAllNodesWithTag(e,t);this._forEachNode(r,(e=>a+=this._getInnerText(e,true).length));return a/i},_cleanConditionally:function(e,t){if(!this._flagIsActive(this.FLAG_CLEAN_CONDITIONALLY))return;this._removeNodes(this._getAllNodesWithTag(e,[t]),(function(e){var i=function(e){return e._readabilityDataTable};var a=t==="ul"||t==="ol";if(!a){var r=0;var n=this._getAllNodesWithTag(e,["ul","ol"]);this._forEachNode(n,(e=>r+=this._getInnerText(e).length));a=r/this._getInnerText(e).length>.9}if(t==="table"&&i(e)){return false}if(this._hasAncestorTag(e,"table",-1,i)){return false}if(this._hasAncestorTag(e,"code")){return false}var s=this._getClassWeight(e);this.log("Cleaning Conditionally",e);var l=0;if(s+l<0){return true}if(this._getCharCount(e,",")<10){var o=e.getElementsByTagName("p").length;var h=e.getElementsByTagName("img").length;var c=e.getElementsByTagName("li").length-100;var d=e.getElementsByTagName("input").length;var g=this._getTextDensity(e,["h1","h2","h3","h4","h5","h6"]);var u=0;var f=this._getAllNodesWithTag(e,["object","embed","iframe"]);for(var _=0;_<f.length;_++){for(var m=0;m<f[_].attributes.length;m++){if(this.REGEXPS.videos.test(f[_].attributes[m].value)){return false}}if(f[_].tagName==="object"&&this.REGEXPS.videos.test(f[_].innerHTML)){return false}u++}var p=this._getLinkDensity(e);var N=this._getInnerText(e).length;var v=h>1&&o/h<.5&&!this._hasAncestorTag(e,"figure")||!a&&c>o||d>Math.floor(o/3)||!a&&g<.9&&N<25&&(h===0||h>2)&&!this._hasAncestorTag(e,"figure")||!a&&s<25&&p>.2||s>=25&&p>.5||(u===1&&N<75||u>1);return v}return false}))},_cleanMatchedNodes:function(e,t){var i=this._getNextNode(e,true);var a=this._getNextNode(e);while(a&&a!=i){if(t.call(this,a,a.className+" "+a.id)){a=this._removeAndGetNext(a)}else{a=this._getNextNode(a)}}},_cleanHeaders:function(e){let t=this._getAllNodesWithTag(e,["h1","h2"]);this._removeNodes(t,(function(e){let t=this._getClassWeight(e)<0;if(t){this.log("Removing header with low class weight:",e)}return t}))},_headerDuplicatesTitle:function(e){if(e.tagName!="H1"&&e.tagName!="H2"){return false}var t=this._getInnerText(e,false);this.log("Evaluating similarity of header:",t,this._articleTitle);return this._textSimilarity(this._articleTitle,t)>.75},_flagIsActive:function(e){return(this._flags&e)>0},_removeFlag:function(e){this._flags=this._flags&~e},_isProbablyVisible:function(e){return(!e.style||e.style.display!="none")&&!e.hasAttribute("hidden")&&(!e.hasAttribute("aria-hidden")||e.getAttribute("aria-hidden")!="true"||e.className&&e.className.indexOf&&e.className.indexOf("fallback-image")!==-1)},parse:function(){if(this._maxElemsToParse>0){var e=this._doc.getElementsByTagName("*").length;if(e>this._maxElemsToParse){throw new Error("Aborting parsing document; "+e+" elements found")}}this._unwrapNoscriptImages(this._doc);var t=this._disableJSONLD?{}:this._getJSONLD(this._doc);this._removeScripts(this._doc);this._prepDocument();var i=this._getArticleMetadata(t);this._articleTitle=i.title;var a=this._grabArticle();if(!a)return null;this.log("Grabbed: "+a.innerHTML);this._postProcessContent(a);if(!i.excerpt){var r=a.getElementsByTagName("p");if(r.length>0){i.excerpt=r[0].textContent.trim()}}var n=a.textContent;return{title:this._articleTitle,byline:i.byline||this._articleByline,dir:this._articleDir,lang:this._articleLang,content:this._serializer(a),textContent:n,length:n.length,excerpt:i.excerpt,siteName:i.siteName||this._articleSiteName}}};if(typeof module==="object"){module.exports=Readability}