/*!
 *                      2022
 * All Rights Reserved for Oziku Technologies LLC
 *            https://www.oziku.tech/
 */

(e=>{const t=e.chrome,i=e.$,s=t.runtime,o=t.tabs,n=t.storage,a=t.i18n,l=n.local;let c;const r=i("html"),g=i("#main"),d=i("#toggle-ext"),u=i("#closeBtn"),p=i("#resetBtn"),f=i("#bigger-text"),h=i("#font-family"),C=i("#bold-text"),k=i("#italic-text"),m=i("#align-text"),S=i("#font-color"),P=i("#line-spacing"),V=i("#word-spacing"),w=i("#letter-spacing"),x=i("#mask-mode"),v=i("#mask-height"),_=i("#mask-brightness"),b=i("#mask-color"),y=i("#screen-tint-color"),O=i("#screen-tint-brightness"),T=i("#bigger-cursor"),F=i("#mute-sounds"),I=i("#pause-anim"),L=i("#hide-images"),M=i("#reader-view"),N=i("#dictionary"),E=i("#read-epub"),B=i("#show-reader"),R=i("#reading-speed"),W=i("#reading-voice"),A=i("#tts-highlight"),$=i("#show-widget"),q=i("#contrast"),H=i("#saturation"),U=i("#highlight-links");function j(){l.get(["config","showWidget"],(e=>{const t=e.config?.isOn??!0;t?g.removeClass("status-off"):g.addClass("status-off");const o=e.config?.scaleValue??"",n=e.config?.readingSpeed||"1",l=e.config?.readingVoice||"1",u=e.config?.ttsHighlight??!1,p=e.config?.boldText??!1,M=e.config?.italicText??!1,E=e.config?.fontColor??"",B=e.config?.alignText??"",j=e.config?.fontFamily??"",G=parseFloat(e.config?.lineSpacing??""),J=e.config?.wordSpacing??"",K=e.config?.letterSpacing??"",Q=e.config?.maskMode??"",Y=e.config?.maskHeight??75,Z=e.config?.maskBrightness??30,ee=e.config?.maskColor||_maskColors[0],te=e.config?.screenTintColor??"",ie=e.config?.screenTintBrightness??55,se=e.config?.biggerCursor??"",oe=e.config?.muteSounds??!1,ne=e.config?.pauseAnim??!1,ae=e.config?.hideImages??!1,le=e.config?.dictionary??!1,ce=e.showWidget??!0,re=e.config?.contrast??"",ge=e.config?.saturation??"",de=e.config?.highlightLinks??!1;let ue,pe;if(d.prop("checked",t),showSelectionPositions(i,f,_biggerTextOptions,o),showSelectionPositions(i,R,_readingSpeedOptions,n),showSelectionPositions(i,W,_readingVoiceOptions,l),showSelectionPositions(i,m,_alignTextOptions,B),showSelectionPositions(i,q,_contrastOptions,re),showSelectionPositions(i,H,_saturationOptions,ge),showColorSelected(i,S,E),showFontFamilySelected(i,h,j),showColorSelected(i,b,ee,b.siblings()),showColorSelected(i,y,te,y.siblings()),showSelectionPositions(i,P,_lineSpacingOptions,G),showSelectionPositions(i,V,_wordSpacingOptions,J),showSelectionPositions(i,w,_letterSpacingOptions,K),showSelectionPositions(i,x,_maskModeOptions,Q,x.siblings()),showSelectionPositions(i,T,_biggerCursorOptions,se),C.toggleClass("selected",p),A.toggleClass("selected",u),k.toggleClass("selected",M),F.toggleClass("selected",oe),I.toggleClass("selected",ne),L.toggleClass("selected",ae),N.toggleClass("selected",le),$.toggleClass("selected",ce),U.toggleClass("selected",de),$.find(".grid-content > p").text(ce?a.getMessage("hide_widget"):a.getMessage("show_widget")),v.find("input").val(Y),v.find("input ~ .value").text(Y+"px"),_.find("input").val(parseInt(_.find("input").attr("min"))+parseInt(_.find("input").attr("max"))-Z),_.find("input ~ .value").text(Z+"%"),O.find("input").val(parseInt(O.find("input").attr("min"))+parseInt(O.find("input").attr("max"))-ie),O.find("input ~ .value").text(ie+"%"),"black"===se?(ue=`url("${s.getURL("res/cursors/cursor_black.svg")}")`,pe=`url("${s.getURL("res/cursors/cursor_black_select.svg")}")`):"white"===se&&(ue=`url("${s.getURL("res/cursors/cursor_white.svg")}")`,pe=`url("${s.getURL("res/cursors/cursor_white_select.svg")}")`),r.removeClass("contrast-dark contrast-invert saturation-low saturation-high desaturate"),t&&"dark"===re&&r.addClass("contrast-dark"),t&&!c)switch("invert"===re&&r.addClass("contrast-invert"),ge){case"low":r.addClass("saturation-low");break;case"high":r.addClass("saturation-high");break;case"desaturate":r.addClass("desaturate");break}ue&&pe?(r.get(0).style.setProperty("--cursor",ue),r.get(0).style.setProperty("--cursor-select",pe)):(r.get(0).style.removeProperty("--cursor"),r.get(0).style.removeProperty("--cursor-select")),X((e=>{e&&(z(e.id),D(e.id))}))}))}function z(e){o.sendMessage(e,{m:"getReaderViewStatus"},void 0,(e=>{s.lastError;M.toggleClass("selected",!!e?.status)}))}function D(e,t){o.sendMessage(e,{m:"getTextToSpeedStatus"},void 0,(e=>{s.lastError;t&&t(!!e?.status),B.toggleClass("selected",!!e?.status),B.siblings().toggleClass("show-check",B.hasClass("selected"))}))}function G(e){e=e??!B.hasClass("selected"),function t(e){o.query({active:!0,currentWindow:!0},(t=>{if(t.length>0){const i=t[0];o.query({},(t=>{e(t,i)}))}else e([],void 0)}))}(((t,i)=>{i&&o.sendMessage(i.id,{m:"updateTextToSpeech",status:e},{frameId:0},(n=>{s.lastError;void 0!==n?.success&&(B.toggleClass("selected",e),B.siblings().toggleClass("show-check",B.hasClass("selected")),delay(250).then((()=>{D(i.id,(e=>{e||t.forEach((e=>{e.id!==i.id&&o.sendMessage(e.id,{m:"updateTextToSpeech",status:!1},{frameId:0},(e=>{s.lastError}))}))}))})))}))}))}function J(){updateConfigValue(l,"maskHeight",parseInt(v.find("input").val()))}function K(){const e=_.find("input");updateConfigValue(l,"maskBrightness",parseInt(e.attr("min"))+parseInt(e.attr("max"))-parseInt(_.find("input").val()))}function Q(){const e=O.find("input");updateConfigValue(l,"screenTintBrightness",parseInt(parseInt(e.attr("min"))+parseInt(e.attr("max"))-e.val()))}function X(e){o.query({active:!0,currentWindow:!0},(t=>{t.length>0?e(t[0]):e(null)}))}i((()=>{s.sendMessage({m:"getMyInfo"},(e=>{s.lastError;c=e.tabId,function t(){c||(i(g.css("width","550px")),u.hide());initPositionLines(f,_biggerTextOptions),initPositionLines(R,_readingSpeedOptions),initPositionLines(W,_readingVoiceOptions),initFonts(h,_fontFamilyOptions),initPositionLines(m,_alignTextOptions),initColorPick(S,_fontColors),initPositionLines(P,_lineSpacingOptions),initPositionLines(V,_wordSpacingOptions),initPositionLines(w,_letterSpacingOptions),initPositionLines(x,_maskModeOptions),initColorPick(b,_maskColors),initColorPick(y,_screenTintColors),initPositionLines(T,_biggerCursorOptions),initPositionLines(q,_contrastOptions),initPositionLines(H,_saturationOptions)}(),j()}))})),u.click((()=>{c&&o.sendMessage(c,{m:"closeSidebar"},{frameId:0},(()=>{s.lastError}))})),p.click((()=>{l.set({config:{}})})),d.change((()=>{updateConfigValue(l,"isOn",d.prop("checked"))})),f.click((()=>{updateConfigValue(l,"scaleValue",getNextSelectionPositionFor(f))})),f.find(".status").click((e=>{e.stopPropagation(),updateConfigValue(l,"scaleValue","")})),R.click((()=>{updateConfigValue(l,"readingSpeed",getNextSelectionPositionFor(R))})),W.click((()=>{updateConfigValue(l,"readingVoice",getNextSelectionPositionFor(W))})),C.click((()=>{updateConfigValue(l,"boldText",!C.hasClass("selected"))})),A.click((()=>{updateConfigValue(l,"ttsHighlight",!A.hasClass("selected"))})),k.click((()=>{updateConfigValue(l,"italicText",!k.hasClass("selected"))})),m.click((()=>{updateConfigValue(l,"alignText",getNextSelectionPositionFor(m))})),m.find(".status").click((e=>{e.stopPropagation(),updateConfigValue(l,"alignText","")})),P.click((()=>{updateConfigValue(l,"lineSpacing",getNextSelectionPositionFor(P))})),P.find(".status").click((e=>{e.stopPropagation(),updateConfigValue(l,"lineSpacing","")})),V.click((()=>{updateConfigValue(l,"wordSpacing",getNextSelectionPositionFor(V))})),V.find(".status").click((e=>{e.stopPropagation(),updateConfigValue(l,"wordSpacing","")})),w.click((()=>{updateConfigValue(l,"letterSpacing",getNextSelectionPositionFor(w))})),w.find(".status").click((e=>{e.stopPropagation(),updateConfigValue(l,"letterSpacing","")})),x.click((()=>{updateConfigValue(l,"maskMode",getNextSelectionPositionFor(x))})),x.find(".status").click((e=>{e.stopPropagation(),updateConfigValue(l,"maskMode","")})),T.click((()=>{updateConfigValue(l,"biggerCursor",getNextSelectionPositionFor(T))})),T.find(".status").click((e=>{e.stopPropagation(),updateConfigValue(l,"biggerCursor","")})),F.click((()=>{updateConfigValue(l,"muteSounds",!F.hasClass("selected"))})),I.click((()=>{updateConfigValue(l,"pauseAnim",!I.hasClass("selected"))})),L.click((()=>{updateConfigValue(l,"hideImages",!L.hasClass("selected"))})),M.click((()=>{d.prop("checked")&&X((e=>{e&&o.sendMessage(e.id,{m:"updateReaderView",status:!M.hasClass("selected")},{frameId:0},(t=>{s.lastError;void 0!==t?.success&&M.toggleClass("selected"),delay(250).then((()=>{z(e.id)}))}))}))})),N.click((()=>{updateConfigValue(l,"dictionary",!N.hasClass("selected"))})),E.click((()=>{o.create({url:"html/epub-reader.html"})})),B.click((()=>{d.prop("checked")&&G()})),$.click((()=>{l.set({showWidget:!$.hasClass("selected")})})),q.click((()=>{updateConfigValue(l,"contrast",getNextSelectionPositionFor(q))})),q.find(".status").click((e=>{e.stopPropagation(),updateConfigValue(l,"contrast","")})),H.click((()=>{updateConfigValue(l,"saturation",getNextSelectionPositionFor(H))})),H.find(".status").click((e=>{e.stopPropagation(),updateConfigValue(l,"saturation","")})),i(document).on("click","#font-color",(e=>{i(e.target).parent().hasClass("grid-colors")?updateConfigValue(l,"fontColor",i(e.target).attr("data-value"),!0):updateConfigValue(l,"fontColor","")})),i(document).on("click","#mask-color",(e=>{i(e.target).parent().hasClass("grid-colors")?updateConfigValue(l,"maskColor",i(e.target).attr("data-value"),!0):updateConfigValue(l,"maskColor","")})),i(document).on("click","#screen-tint-color",(e=>{i(e.target).parent().hasClass("grid-colors")?updateConfigValue(l,"screenTintColor",i(e.target).attr("data-value"),!0):updateConfigValue(l,"screenTintColor","")})),U.click((()=>{updateConfigValue(l,"highlightLinks",!U.hasClass("selected"))})),v.find("input").change(J),v.find("input").mousemove(J),_.find("input").change(K),_.find("input").mousemove(K),O.find("input").change(Q),O.find("input").mousemove(Q),i(document).on("click","#font-family",(e=>{const t=i(e.target);t.parent().hasClass("fonts-container")&&!t.hasClass("selected")?updateConfigValue(l,"fontFamily",t.css("--font-family")):updateConfigValue(l,"fontFamily","")})),n.onChanged.addListener(((e,t)=>{void 0===e.config&&void 0===e.showWidget||j()})),document.querySelectorAll("[data-locale]").forEach((e=>{e.innerText=a.getMessage(e.dataset.locale)||e.innerText.replaceAll(/\n/g,"").replaceAll(/ +(?= )/g,"")}))})(this);